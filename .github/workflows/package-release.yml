name: Publish Cosmere Mods to GitHub

on:
  push:
    branches:
      - '*'
      - '!main'

jobs:
  github-get-mods:
    runs-on: ubuntu-latest
    outputs:
      mods: ${{ steps.set-mods.outputs.mods }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Determine changed Cosmere mods
        id: set-mods
        run: |
          mods=$(find . -maxdepth 1 -type d -name "Cosmere*" -exec basename {} \; | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "mods=$mods" >> "$GITHUB_OUTPUT"

  github-prepare:
    needs: github-get-mods
    runs-on: ubuntu-latest
    outputs:
      changenote: ${{ steps.prepare.outputs.changenote }}
      zip: ${{ steps.prepare.outputs.zip }}
    strategy:
      matrix:
        mod: ${{ fromJson(needs.github-get-mods.outputs.mods) }}
    
    env:
      BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
      MOD: ${{ matrix.mod }}
      TEMP_DIR: "/tmp/${{ matrix.mod }}_upload"

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Dotnet
        uses: actions/setup-dotnet@v2
        with:
          dotnet-version: 9.0.x

      - name: Set up Node
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install steamdown + steam-totp
        run: |
          npm install -g @steamdown/cli tsx
          cd .scripts && npm i

      - name: Install Mod Dependencies
        run: dotnet restore $MOD/$MOD

      - name: Build Mod
        run: dotnet build $MOD/$MOD --configuration Release --no-restore

      - name: Prepare upload directory
        id: prepare
        run: |
          FILE_ID=$(cat "$MOD/About/PublishedFileId.txt")
          DESCRIPTION_FILE="$TEMP_DIR/steam_description.txt"

          mkdir -p "$TEMP_DIR"

          echo "ðŸ“„ Generating description..."
          cat .github/README.header.md "$MOD/README.md" .github/README.footer.md | steamdown > "$DESCRIPTION_FILE"

          echo "ðŸš« Respecting .steamignore..."
          if [ -f "$MOD/.steamignore" ]; then
            rsync -av --exclude-from="$MOD/.steamignore" --exclude=".steamignore" "$MOD/" "$TEMP_DIR"
          else
            rsync -av "$MOD/" "$TEMP_DIR"
          fi

          CHANGE_NOTE=$(git log -1 --pretty=%B | sed 's/"/\\"/g')
          ESCAPED_DESCRIPTION=$(sed 's/"/\\"/g' "$DESCRIPTION_FILE")

          {
            echo '"workshopitem"'
            echo '{'
            echo '  "appid" "294100"'
            echo "  \"publishedfileid\" \"$FILE_ID\""
            echo "  \"contentfolder\" \"$TEMP_DIR\""
            echo "  \"changenote\" \"$CHANGE_NOTE\""
            echo "  \"description\" \"$ESCAPED_DESCRIPTION\""
            echo '}'
          } > "$TEMP_DIR/workshop.vdf"

          echo "âœ… Generated workshop.vdf:"
          cat "$TEMP_DIR/workshop.vdf"
          
          echo "changenote=$CHANGE_NOTE" >> "$GITHUB_OUTPUT"
          echo "vdfpath=$TEMP_DIR/workshop.vdf" >> "$GITHUB_OUTPUT"
      - name: Upload zip artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.mod }}-zip
          path: ${{ github.workspace }}/${{ matrix.mod }}-${{ env.BRANCH_NAME }}.zip
  
  github-publish:
    needs: github-prepare
    runs-on: ubuntu-latest
    env:
      BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
      MOD: ${{ matrix.mod }}
      TEMP_DIR: "/tmp/${{ matrix.mod }}_upload"

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Download all zip artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./zips

      - name: List all zip files
        run: |
          echo "Zips downloaded:"
          find ./zips -name "*.zip"

      - name: Get latest commit message
        id: commit
        run: |
          BODY=$(git log -1 --pretty=%B | sed 's/"/\\"/g')
          echo "body=$BODY" >> "$GITHUB_OUTPUT"

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          name: Cosmere Mods - ${{ github.ref_name }}
          body: ${{ steps.commit.outputs.body }}
          prerelease: true
          files: ./zips/**/*.zip
          make_latest: false